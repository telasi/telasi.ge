<%
  seltab = case params[:tab]
  when 'docs' then 1
  when 'sms'  then 2
  when 'sys'  then 3
  else 0 end

%>
<%= view_for @registration, title: @title, icon: '/icons/user.png', collapsible: true, selected_tab: seltab do |f|
  f.tab title: t('models.billing_customer_registration.title.single_alt'), icon: '/icons/user.png' do |t|
    @registration.transitions.each do |stat|
      t.action admin_change_customer_status_url(id: @registration.id, new_status: stat),
        label: Customer::Registration.status_name(stat),
        icon: Customer::Registration.status_icon(stat)
    end
    t.complex_field label: 'მომხმარებელი', required: true do |c|
      c.email_field 'user.email'
      c.text_field 'user.full_name', url: admin_user_url(id: @registration.user.id)
      c.text_field 'user.formatted_mobile'
    end
    t.complex_field i18n: 'customer', required: true do |c|
      c.text_field 'customer.accnumb', tag: 'code'
      c.text_field 'customer.custname'
      c.text_field 'customer.address', class: 'text-muted'
    end
    t.text_field 'category_name', i18n: 'category', required: true
    t.text_field 'ownership_name', i18n: 'ownership', required: true
    t.complex_field i18n: 'status', required: true do |c|
      c.image_field 'status_icon'
      c.text_field 'status_name'
    end
    t.text_field :rs_tin, required: true, tag: 'code'
    t.text_field :rs_name, required: true
    t.complex_field label: 'მისამართი', required: true do |c|
      c.text_field :address_code, tag: 'code'
      c.text_field :address
    end
  end
  f.tab title: "დოკუმენტები &mdash; <strong>#{@registration.documents.size}</strong>".html_safe,
        icon: '/icons/documents.png' do |t|
    t.action admin_generate_customer_docs_url(id: @registration.id), label: 'დოკუმენტების გენერაცია', icon: '/icons/wand.png', method: 'post', confirm: 'ნამდვილად გინდათ დოკუმენტების გენერაცია?'
    t.table_field :documents, table: { title: 'ატვირთული დოკუმენტები', icon: '/icons/documents.png' } do |documents|
      documents.table do |t|
        t.text_field 'file_name', label: 'მომაგრებული ფაილი', url: ->(x) { x.file.url }
        t.text_field 'document_type.name', label: 'დოკუმენტის სახეობა'
        t.boolean_field 'denied', label: 'უარყოფილი?'
        t.text_field 'denial_reason', label: 'უარყოფის მიზეზი'
      end
    end
  end
  f.tab title: "შეტყობინებები &mdash; <strong>#{@registration.messages.size}</strong>".html_safe,
        icon: '/icons/mobile-phone.png' do |t|
    t.table_field :messages, table: { title: 'გაგზავნილი შეტყობინებები', icon: '/icons/mobile-phone.png' } do |messages|
      messages.table do |t|
        t.date_field 'created_at', formatter: '%d-%b-%Y %H:%M:%S'
        t.text_field 'mobile', tag: 'code'
        t.text_field 'message'
      end
    end
  end
  f.tab title: t('models.general.system'), icon: '/icons/traffic-cone.png' do |t|
    t.timestamps
  end
end %>